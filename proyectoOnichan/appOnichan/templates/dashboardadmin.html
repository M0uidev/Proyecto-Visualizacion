{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Admin{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboardtrabajador.css' %}">
  <style>
    #chileMap {
        height: 1000px;
        min-width: 310px;
        margin: 0 auto;
    }
    .loading {
        margin-top: 10em;
        text-align: center;
        color: gray;
    }
    
    .modal.show .modal-dialog {
        transform: scale(1.25) !important;
        transform-origin: top center;
        margin-top: 5%; 
    }
  </style>
{% endblock %}

{% block content %}
  <main class="container-fluid py-4">
    <div class="dashboard-wrapper dash-card p-4">
      <!-- KPIs Section (Always Visible) -->
      <section class="row g-4 mb-4">
        <div class="col-12 col-md-4">
          <article class="dash-card metric-card" aria-labelledby="metricPedidosHoy">
            <span class="metric-label" id="metricPedidosHoy">Ventas hoy</span>
            <span class="metric-value" data-kpi="pedidos_hoy">--</span>
            <span class="metric-trend" data-kpi-trend="pedidos_hoy">&nbsp;</span>
          </article>
        </div>
        <div class="col-12 col-md-4">
          <article class="dash-card metric-card" aria-labelledby="metricPendientes">
            <span class="metric-label" id="metricPendientes">Pedidos Pendientes</span>
            <span class="metric-value" data-kpi="pendientes">--</span>
            <span class="metric-trend" data-kpi-trend="pendientes">&nbsp;</span>
          </article>
        </div>
        <div class="col-12 col-md-4">
          <article class="dash-card metric-card" aria-labelledby="metricIngresos">
            <span class="metric-label" id="metricIngresos">Ingresos ({{ period_title }})</span>
            <span class="metric-value" data-kpi="ingresos_7d">--</span>
            <span class="metric-trend" data-kpi-trend="ingresos_7d">&nbsp;</span>
          </article>
        </div>
      </section>

      <div class="mb-4 d-flex flex-wrap gap-2 align-items-center justify-content-end">
        <form id="dashboardFilterForm" method="get" class="d-flex align-items-center gap-2">
          <a id="btnPrevPeriod" class="btn btn-pastel-secondary {% if not prev_url %}disabled{% endif %}" {% if prev_url %}href="{{ prev_url }}"{% endif %} title="Anterior">⟵</a>
          <div class="btn-group" role="group" aria-label="Selector de Periodo">
            <input type="radio" class="btn-check" name="period" id="periodWeek" value="week" autocomplete="off" {% if period == 'week' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="periodWeek">Semana</label>

            <input type="radio" class="btn-check" name="period" id="periodMonth" value="month" autocomplete="off" {% if period == 'month' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="periodMonth">Mes</label>

            <input type="radio" class="btn-check" name="period" id="periodYear" value="year" autocomplete="off" {% if period == 'year' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="periodYear">Año</label>
          </div>
          
          <div class="input-group period-input" id="input-week" {% if period != 'week' %}style="display:none;"{% endif %}>
            <span class="input-group-text">Semana</span>
            <input type="date" class="form-control" name="week" value="{% if period == 'week' %}{{ ref_value|default:'' }}{% endif %}" />
          </div>
          
          <div class="input-group period-input" id="input-month" {% if period != 'month' %}style="display:none;"{% endif %}>
            <span class="input-group-text">Mes</span>
            <input type="month" class="form-control" name="month" value="{% if period == 'month' %}{{ ref_value|default:'' }}{% endif %}" />
          </div>
          
          <div class="input-group period-input" id="input-year" {% if period != 'year' %}style="display:none;"{% endif %}>
            <span class="input-group-text">Año</span>
            <input type="number" class="form-control" name="year" value="{% if period == 'year' %}{{ ref_value|default:'' }}{% endif %}" />
          </div>
          <a id="btnNextPeriod" class="btn btn-pastel-secondary" href="{{ next_url }}" title="Siguiente">⟶</a>
        </form>
      </div>

      <style>
        /* Force consistent width for period inputs */
        .period-input {
            min-width: 240px; /* Adjust based on preference, matches typical month input width */
            max-width: 240px;
        }
        /* Ensure disabled link looks disabled */
        a.disabled {
            pointer-events: none;
            opacity: 0.5;
            cursor: default;
        }
      </style>

      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="ventas-tab" data-bs-toggle="tab" data-bs-target="#ventas" type="button" role="tab" aria-controls="ventas" aria-selected="true">Ventas</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="mapa-tab" data-bs-toggle="tab" data-bs-target="#mapa" type="button" role="tab" aria-controls="mapa" aria-selected="false">Análisis Regional</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button" role="tab" aria-controls="clientes" aria-selected="false">Comportamiento de Cliente</button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="dashboardTabsContent">
        
        <!-- Ventas Tab -->
        <div class="tab-pane fade show active" id="ventas" role="tabpanel" aria-labelledby="ventas-tab">
          <!-- Grafico de lineas y pastel -->
          <section class="row g-4">
            <div class="col-12 col-lg-7">
              <article class="dash-card chart-card" aria-labelledby="chartLineTitle">
                <header>
                  <h3 id="chartLineTitle">{{ title_text }}</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="ordersLineChart" aria-describedby="chartLineTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
            <div class="col-12 col-lg-5">
              <article class="dash-card chart-card" aria-labelledby="chartPieTitle">
                <header class="d-flex justify-content-between align-items-center">
                  <h3 id="chartPieTitle" class="mb-0">Top productos</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="topProductsPieChart" aria-describedby="chartPieTitle" style="width:100%; height:100%;"></div>
                </div>
                <div class="chart-legend" id="topProductsLegend" aria-hidden="true"></div>
              </article>
            </div>
          </section>

          <!-- Grafico de barras y Multi Series Pie -->
          <section class="row g-4 mt-2">
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="chartBarTitle">
                <header>
                  <h3 id="chartBarTitle">Productos vendidos por categoría</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="categoryRevenueBarChart" aria-describedby="chartBarTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="treemapTitle">
                <header>
                  <h3 id="treemapTitle">Distribución de Ventas</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="salesTreemapChart" aria-describedby="treemapTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
          </section>
        </div>

        <!-- Mapa Tab -->
        <div class="tab-pane fade" id="mapa" role="tabpanel" aria-labelledby="mapa-tab">
          <section class="row g-4">
            <!-- Map Column -->
            <div class="col-12 col-lg-9">
              <article class="dash-card chart-card" aria-labelledby="chartMapTitle">
                <header>
                  <h3 id="chartMapTitle">Ventas por Región</h3>
                </header>
                <div class="chart-wrapper d-flex justify-content-center align-items-center" style="height: auto; min-height: 800px; background-color: #e9ecef;">
                  <div id="chileMap" style="width: 100%; background-color: #dee2e6; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
              </article>
            </div>
            
            <!-- Table Column -->
            <div class="col-12 col-lg-3">
              <article class="dash-card chart-card" aria-labelledby="tableMapTitle">
                <header>
                  <h3 id="tableMapTitle">Detalle Regional</h3>
                </header>
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                  <table class="table table-hover" id="regionSalesTable">
                    <thead>
                      <tr>
                        <th>Región</th>
                        <th class="text-end">Ventas</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Populated by JS -->
                    </tbody>
                  </table>
                </div>
              </article>
            </div>
          </section>
        </div>

        <!-- Clientes Tab -->
        <div class="tab-pane fade" id="clientes" role="tabpanel" aria-labelledby="clientes-tab">
          <!-- Row 1: New vs Returning -->
          <section class="row g-4 mb-4">
            <div class="col-12">
              <article class="dash-card chart-card" aria-labelledby="chartRetentionTitle">
                <header>
                  <h3 id="chartRetentionTitle">Adquisición y Retención de Clientes</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="retentionChart" aria-describedby="chartRetentionTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
          </section>

          <!-- Row 2: Frequency & Ticket -->
          <section class="row g-4 mb-4">
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="chartFrequencyTitle">
                <header>
                  <h3 id="chartFrequencyTitle">Frecuencia de Compra (Pedidos por Cliente)</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="frequencyChart" aria-describedby="chartFrequencyTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="chartTicketTitle">
                <header>
                  <h3 id="chartTicketTitle">Distribución de la Venta de Compra</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="ticketChart" aria-describedby="chartTicketTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
          </section>

          <!-- Row 3: Top Customers & Day of Week -->
          <section class="row g-4">
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="chartTopCustomersTitle">
                <header>
                  <h3 id="chartTopCustomersTitle">Top 10 Clientes (Mayor Gasto)</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="topCustomersChart" aria-describedby="chartTopCustomersTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
            <div class="col-12 col-lg-6">
              <article class="dash-card chart-card" aria-labelledby="chartDayOfWeekTitle">
                <header>
                  <h3 id="chartDayOfWeekTitle">Actividad por Día de la Semana</h3>
                </header>
                <div class="chart-wrapper" style="height: 400px;">
                  <div id="dayOfWeekChart" aria-describedby="chartDayOfWeekTitle" style="width:100%; height:100%;"></div>
                </div>
              </article>
            </div>
          </section>
        </div>

      </div>
    </div>

    <!-- Modal -->
    <div id="dashModal" class="modal fade" tabindex="-1" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content modal-card">
          <div class="modal-header modal-head">
            <h5 class="modal-title" id="dashModalTitle">Detalle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="dashModalChart"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Region Detail Modal -->
    <div class="modal fade" id="regionModal" tabindex="-1" aria-labelledby="regionModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="regionModalLabel">Detalle Regional</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h4 id="modalRegionName" class="mb-3"></h4>
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Ventas Totales
                <span class="badge bg-primary rounded-pill" id="modalSales"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Categoría Top
                <span class="badge bg-success rounded-pill" id="modalCategory"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Pedidos Únicos
                <span class="badge bg-info rounded-pill" id="modalOrders"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Productos Distintos
                <span class="badge bg-warning rounded-pill" id="modalProducts"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Venta Promedio
                <span class="badge bg-secondary rounded-pill" id="modalTicket"></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script type="application/json" id="dashboard-data" data-period="{{ period }}" data-ref-value="{{ ref_value }}">{{ data_json|default:"{}"|safe }}</script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/variable-pie.js"></script>
  <script src="https://code.highcharts.com/modules/treemap.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script>const apiDashboardUrl = "{% url 'api_dashboard_data' %}";</script>
  <script src="{% static 'js/dashboardadmin.js' %}?v=4.24"></script>

  <script src="https://code.highcharts.com/maps/modules/map.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const apiParams = window.location.search;

        (async () => {
            try {
                // Map standard Chile region IDs to Highcharts hc-keys
                const regionKeyMap = {
                    1: 'cl-ta', 2: 'cl-an', 3: 'cl-at', 4: 'cl-co', 5: 'cl-vs',
                    6: 'cl-li', 7: 'cl-ml', 8: 'cl-bi', 9: 'cl-2730', 10: 'cl-ll',
                    11: 'cl-ai', 12: 'cl-ma', 13: 'cl-rm', 14: 'cl-ar', 15: 'cl-2740', 16: 'cl-nb'
                };

                const [regionsMeta, geojson, salesData] = await Promise.all([
                    fetch("{% static 'chile-regiones-2025.json' %}").then(r => r.json()),
                    fetch("https://code.highcharts.com/mapdata/countries/cl/cl-all.geo.json").then(r => r.json()),
                    fetch("{% url 'regional_analysis_api' %}" + apiParams).then(r => r.json())
                ]);

                const data = [];
                
                regionsMeta.forEach(r => {
                    const regionName = r.nombre_region;
                    
                    let regionData = salesData[regionName];
                    if (!regionData && regionName.startsWith("Región de ")) {
                        regionData = salesData[regionName.replace("Región de ", "").trim()];
                    }
                    if (!regionData && regionName.startsWith("Región del ")) {
                        regionData = salesData[regionName.replace("Región del ", "").trim()];
                    }

                    // Use orders for value (color), but keep sales for display
                    const orders = regionData ? regionData.pedidos_unicos : 0;
                    const sales = regionData ? regionData.ventas_totales : 0;
                    
                    data.push({
                        hcKey: regionKeyMap[r.id_region],
                        value: orders, // Color based on orders
                        sales: sales,
                        regionName: regionName,
                        orders: orders,
                        topCategory: regionData ? regionData.categoria_top : '-',
                        products: regionData ? regionData.productos_distintos : 0,
                        ticket: regionData ? regionData.ticket_promedio : 0
                    });
                });

                Highcharts.mapChart('chileMap', {
                    chart: {
                        map: geojson,
                        backgroundColor: '#141414'
                    },
                    title: {
                        text: 'Ventas por Región',
                        style: {
                            color: '#ffffff'
                        }
                    },
                    mapNavigation: {
                        enabled: true,
                        buttonOptions: {
                            verticalAlign: 'bottom'
                        }
                    },
                    colorAxis: {
                        min: 0,
                        stops: [
                            [0, '#193748'],
                            [1, '#2CAEFD']
                        ],
                        labels: {
                            style: {
                                color: '#ffffff'
                            }
                        }
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        title: {
                            text: 'Pedidos',
                            style: {
                                color: '#ffffff'
                            }
                        },
                        itemStyle: {
                            color: '#ffffff'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        borderColor: '#333333',
                        borderRadius: 8,
                        borderWidth: 1,
                        shadow: true,
                        style: {
                            color: '#ffffff',
                            fontSize: '15px',
                            padding: '12px'
                        },
                        useHTML: true,
                        formatter: function () {
                            const p = this.point;
                            if (!p.regionName) return this.series.name;
                            
                            const formattedSales = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.sales);
                            const formattedTicket = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.ticket);
                            
                            return `<span style="font-size: 16px; font-weight: bold">${p.regionName}</span><br>` +
                                   `Pedidos: ${p.orders}<br>` +
                                   `Ventas: ${formattedSales}<br>` +
                                   `Venta Promedio: ${formattedTicket}<br>` +
                                   `Top Categoría: ${p.topCategory}`;
                        }
                    },
                    series: [{
                        data: data,
                        joinBy: ['hc-key', 'hcKey'],
                        name: 'Pedidos',
                        borderColor: '#333333',
                        borderWidth: 1,
                        states: {
                            hover: {
                                color: '#a4edba'
                            }
                        },
                        dataLabels: {
                            enabled: true,
                            format: '{point.regionName}',
                            style: {
                                color: '#ffffff',
                                textOutline: 'none',
                                fontWeight: 'normal',
                                fontSize: '14px'
                            }
                        },
                        point: {
                            events: {
                                click: function () {
                                    const p = this;
                                    document.getElementById('modalRegionName').innerText = p.regionName;
                                    document.getElementById('modalSales').innerText = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.sales);
                                    document.getElementById('modalCategory').innerText = p.topCategory;
                                    document.getElementById('modalOrders').innerText = p.orders;
                                    document.getElementById('modalProducts').innerText = p.products;
                                    document.getElementById('modalTicket').innerText = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.ticket);
                                    
                                    new bootstrap.Modal(document.getElementById('regionModal')).show();
                                }
                            }
                        }
                    }]
                });

                const tableBody = document.querySelector('#regionSalesTable tbody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    // Sort by orders now? Or keep sales? Usually sales is more important for the table.
                    // Let's keep sales for the table as it's "Detalle Regional"
                    const sortedData = [...data].sort((a, b) => b.sales - a.sales);
                    
                    sortedData.forEach(item => {
                        const tr = document.createElement('tr');
                        const formattedSales = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(item.sales);
                        tr.innerHTML = `
                            <td>
                                <div class="fw-bold">${item.regionName}</div>
                                <small class="text-muted">Top Categoría: ${item.topCategory}</small>
                            </td>
                            <td class="text-end">
                                <div class="fw-bold">${formattedSales}</div>
                                <small class="text-muted">${item.orders} pedidos</small>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }

            } catch (error) {
                console.error("Error initializing map:", error);
            }
        })();
    });
  </script>
{% endblock %}
