{% extends "base.html" %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
<div class="container">
  <section class="mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-4 align-items-lg-end">
      <div>
        <p class="text-uppercase muted small mb-1">Panel de control</p>
        <h1 class="display-6 fw-semibold mb-1 text-break">Panel de Administración</h1>
        <p class="muted mb-0">Resumen ejecutivo de ventas y comportamiento de compra.</p>
      </div>
      <div class="row g-3 flex-grow-1">
        <div class="col-12 col-lg-6">
          <label for="dateRange" class="form-label small text-uppercase muted">Rango de fechas</label>
          <input id="dateRange" type="text" class="form-control" value="{{ filters.date_range }}" readonly>
        </div>
        <div class="col-12 col-lg-6">
          <label for="storeSelect" class="form-label small text-uppercase muted">Tienda</label>
          <select id="storeSelect" class="form-select">
            {% for store in filters.stores %}
            <option value="{{ store.value }}" {% if store.value == filters.selected_store %}selected{% endif %}>{{ store.label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-4">
    <div class="row g-4">
      {% for card in kpis %}
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card-surface p-4 h-100">
          <p class="text-uppercase small muted mb-1">{{ card.label }}</p>
          <h2 class="h3 fw-semibold mb-2">{{ card.value }}</h2>
          <span class="badge text-bg-success-subtle text-success">{{ card.delta }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <section class="mb-4">
    <div class="row g-4">
      <div class="col-12 col-xl-6">
        <div class="card-surface h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Ventas por día</span>
            <small class="muted">Interactividad habilitada</small>
          </div>
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <canvas id="chartSalesByDay" data-chart='{{ sales_daily|escapejs }}'></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card-surface h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Top 5 categorías</span>
            <small class="muted">Click para detalle</small>
          </div>
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <canvas id="chartTopCategories" data-chart='{{ top_categories|escapejs }}'></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card-surface">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Distribución de compras</span>
            <small class="muted">Incluye boxplot</small>
          </div>
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <canvas id="chartPurchaseDistribution" data-chart='{{ purchase_distribution|escapejs }}'></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card-surface">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Órdenes recientes</span>
        <a href="#" class="link-muted small">Ver todo</a>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Cliente</th>
              <th scope="col">Producto</th>
              <th scope="col">Total</th>
              <th scope="col">Fecha</th>
            </tr>
          </thead>
          <tbody>
            {% for order in recent_orders %}
            <tr>
              <td class="fw-semibold">{{ order.id }}</td>
              <td>{{ order.customer }}</td>
              <td>{{ order.product }}</td>
              <td>{{ order.total }}</td>
              <td>{{ order.date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <footer class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 muted small">
    <span>Última actualización: {{ filters.last_updated }}</span>
    <span>Datos filtrados para {{ filters.selected_store_label }}</span>
  </footer>
</div>
{% endblock %}

{% block extra_js %}
<!-- Modal genérico -->
<div class="modal fade" id="drillModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="drillTitle">Detalle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="ratio ratio-16x9">
          <canvas id="drillChartCanvas"></canvas>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm" id="drillTable"></table>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="{% static 'js/admin_dashboard.js' %}"></script>
{% endblock %}
