{% load static %}
{% load roles %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Multitienda{% endblock %}</title>
  
  <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}?v=3" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Sistema de Diseño: Variables primero, luego componentes, luego base -->
  <link rel="stylesheet" href="{% static 'css/variables.css' %}?v=5" />
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v=5" />
  <link rel="stylesheet" href="{% static 'css/components/badges.css' %}?v=5" />
  <link rel="stylesheet" href="{% static 'css/base.css' %}?v=5" />

  {% block extra_css %}{% endblock %}
</head>
<body>
  <header>
    <nav class="navbar-custom" aria-label="Principal">
      <a href="{% url 'index' %}" class="brand-logo">
        <i class="bi bi-shop-window"></i>
        <span>Multitienda</span>
      </a>
      
      {% block nav_left %}{% endblock %}
      
      <div class="nav-actions">
        {% block nav_right %}
          {% include 'partials/navbar_right.html' %}
        {% endblock %}
        
        <a href="#mainMenu" class="nav-link-custom" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="mainMenu">
          <i class="bi bi-list"></i>
        </a>
      </div>
    </nav>
  </header>

  <!-- Menú -->
  <div class="collapse menu-panel" id="mainMenu">
    <div class="menu-inner">
      <div class="menu-col">
        <h6>Tienda</h6>
        <a href="#">Novedades</a>
        <a href="#">Ofertas</a>
        <a href="#">Lo más vendido</a>
      </div>
      <div class="menu-col">
        <h6>Categorías</h6>
        <a href="#">Electrónica</a>
        <a href="#">Ropa</a>
        <a href="#">Hogar</a>
        <a href="#">Juguetes</a>
      </div>
      <div class="menu-col">
        <h6>Cuenta</h6>
        {% if user.is_authenticated %}
            <a href="{% url 'profile' %}">Mi Perfil</a>
        {% endif %}
        <a href="#">Mis pedidos</a>
        <a href="#">Favoritos</a>
        <a href="#">Soporte</a>
        
      </div>
      <div class="menu-col">
        <h6>Más</h6>
        <a href="#">Sucursales</a>
        <a href="#">Envíos y devoluciones</a>
        <a href="#">Términos y privacidad</a>
        {% if user.is_authenticated %}
          {% if user.is_staff or user.is_superuser or user|has_group:'admin' %}
            <a href="{% url 'dashboardadmin' %}">Dashboard admin</a>
          {% elif user|has_group:'trabajador' %}
            <a href="{% url 'dashboardtrabajador' %}">Dashboard trabajador</a>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}">Iniciar sesión</a>
          <a href="{% url 'register' %}">Registrarse</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <main class="page-content">
    {% block content %}{% endblock %}
  </main>

  <!-- Pie de página -->
  <footer class="site-footer pt-5 pb-4" style="background-color: var(--bg-surface); border-top: 1px solid rgba(0,0,0,0.05);">
    <div class="container">
      <div class="row g-4 text-start">
        <div class="col-lg-4 col-md-6">
          <h5 class="fw-bold mb-3" style="color: var(--color-primary-dark);">Multitienda</h5>
          <p class="text-muted small">Tu tienda de confianza para encontrar lo mejor en tecnología, hogar y moda. Calidad y estilo en un solo lugar.</p>
          <div class="d-flex gap-3 mt-3">
            <a href="#" class="text-muted fs-5"><i class="bi bi-facebook"></i></a>
            <a href="#" class="text-muted fs-5"><i class="bi bi-instagram"></i></a>
            <a href="#" class="text-muted fs-5"><i class="bi bi-twitter-x"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-6">
          <h6 class="fw-bold mb-3">Tienda</h6>
          <ul class="list-unstyled text-muted small d-flex flex-column gap-2">
            <li><a href="{% url 'pagina1' %}">Inicio</a></li>
            <li><a href="{% url 'pagina1' %}?sort=newest">Novedades</a></li>
            <li><a href="{% url 'pagina1' %}?sort=price_asc">Ofertas</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6">
          <h6 class="fw-bold mb-3">Ayuda</h6>
          <ul class="list-unstyled text-muted small d-flex flex-column gap-2">
            <li><a href="#">Centro de ayuda</a></li>
            <li><a href="#">Seguimiento de compra</a></li>
            <li><a href="#">Envíos y devoluciones</a></li>
            <li><a href="#">Términos y condiciones</a></li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-6">
          <h6 class="fw-bold mb-3">Contacto</h6>
          <ul class="list-unstyled text-muted small d-flex flex-column gap-2">
            <li><i class="bi bi-envelope me-2"></i> contacto@multitienda.cl</li>
            <li><i class="bi bi-telephone me-2"></i> +56 9 1234 5678</li>
            <li><i class="bi bi-geo-alt me-2"></i> Av. Principal 123, Santiago</li>
          </ul>
        </div>
      </div>
      <div class="border-top mt-5 pt-4 text-center text-muted small">
        <p class="mb-0">© 2025 Multitienda. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Contenedor de Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <!-- Toast del carrito existente -->
    <div id="cartToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-check-circle-fill text-success me-2"></i>Producto agregado al carrito
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>

    <!-- Toasts de mensajes de Django -->
    {% if messages %}
      {% for message in messages %}
        <div class="toast align-items-center text-bg-{% if message.tags == 'error' %}danger{% elif message.tags == 'debug' %}secondary{% else %}{{ message.tags }}{% endif %} border-0 message-toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              {% if message.tags == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>{% endif %}
              {% if message.tags == 'error' %}<i class="bi bi-exclamation-circle-fill me-2"></i>{% endif %}
              {% if message.tags == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>{% endif %}
              {% if message.tags == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Toast de notificación para trabajador -->
  {% if user.is_authenticated %}
  {% if user.is_staff or user.is_superuser or user|has_group:'admin' or user|has_group:'trabajador' %}
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="newOrderToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-primary text-white">
        <i class="bi bi-bell-fill me-2"></i>
        <strong class="me-auto">Nuevo Pedido</strong>
        <small>Justo ahora</small>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ¡Ha llegado un nuevo pedido!
        <div class="mt-2 pt-2 border-top">
          <a href="{% url 'fulfillment_game' %}" class="btn btn-primary btn-sm w-100">Ir a Preparación</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificación inicial para establecer badge de línea base
        fetch("{% url 'check_new_orders' %}")
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('worker-orders-badge');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(err => console.error('Error en verificación inicial:', err));

        // WebSocket para actualizaciones en tiempo real
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = protocol + window.location.host + '/ws/orders/';
        
        const socket = new WebSocket(wsUrl);

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'order_new') {
                // Actualiza badge
                const badge = document.getElementById('worker-orders-badge');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Muestra Toast
                const toastEl = document.getElementById('newOrderToast');
                if (toastEl) {
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
                
                // Dispara evento personalizado para que otras páginas escuchen
                window.dispatchEvent(new CustomEvent('newOrderDetected'));
            }
        };

        socket.onclose = function(e) {
            console.error('Socket de pedidos cerrado inesperadamente');
        };
    });
  </script>
  {% endif %}
  {% endif %}

  {% block modals %}{% endblock %}

  <!-- JS Bundle de Bootstrap 5 -->
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script>
    // Fix para modales Bootstrap con zoom - asegurar que backdrop cubra toda la pantalla y eliminar duplicados
    document.addEventListener('DOMContentLoaded', function() {
      // Función para limpiar backdrops duplicados
      function cleanupBackdrops() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 1) {
          // Mantener solo el último (el más reciente)
          for (let i = 0; i < backdrops.length - 1; i++) {
            backdrops[i].remove();
          }
        }
      }
      
      // Función para ajustar backdrop único
      function adjustBackdrop() {
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.style.width = '133.33vw';
          backdrop.style.height = '133.33vh';
          backdrop.style.left = '0';
          backdrop.style.top = '0';
          backdrop.style.position = 'fixed';
        }
      }
      
      // Ajustar backdrop cuando se muestra un modal de Bootstrap (solo .modal.fade)
      document.addEventListener('show.bs.modal', function(e) {
        // Solo procesar modales de Bootstrap (con clase .fade)
        if (!e.target.classList.contains('fade')) {
          // Si es modal custom, eliminar cualquier backdrop de Bootstrap
          setTimeout(function() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(b => b.remove());
          }, 10);
          return;
        }
        
        setTimeout(function() {
          cleanupBackdrops();
          adjustBackdrop();
        }, 10);
      });
      
      // Ajustar backdrop después de que se muestre completamente
      document.addEventListener('shown.bs.modal', function(e) {
        if (!e.target.classList.contains('fade')) {
          return;
        }
        
        cleanupBackdrops();
        adjustBackdrop();
      });
      
      // Limpiar backdrops duplicados cuando se cierra el modal
      document.addEventListener('hidden.bs.modal', function() {
        // Bootstrap debería eliminar el backdrop, pero limpiamos por si acaso
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(function(backdrop) {
          backdrop.remove();
        });
      });
      
      // Observer para detectar cuando se agregan backdrops al DOM
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === 1 && node.classList && node.classList.contains('modal-backdrop')) {
                // Verificar si hay un modal custom abierto
                const customModal = document.querySelector('.modal:not(.fade).show');
                if (customModal) {
                  // Si hay modal custom abierto, eliminar backdrop de Bootstrap
                  node.remove();
                } else {
                  // Si es modal de Bootstrap, ajustar tamaño
                  setTimeout(function() {
                    cleanupBackdrops();
                    adjustBackdrop();
                  }, 10);
                }
              }
            });
          }
        });
      });
      
      // Observar cambios en el body
      observer.observe(document.body, {
        childList: true,
        subtree: false
      });
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        const toastEl = document.getElementById('cartToast');
        const toast = new bootstrap.Toast(toastEl);

        // Initialize Django Message Toasts
        const messageToasts = document.querySelectorAll('.message-toast');
        messageToasts.forEach(toastEl => {
            const t = new bootstrap.Toast(toastEl, { delay: 5000 });
            t.show();
        });

        document.body.addEventListener('click', function(e) {
            const btn = e.target.closest('.add-to-cart-btn');
            if (btn) {
                e.preventDefault();
                const url = btn.getAttribute('href');
                
                // Agrega parámetro ajax=1
                const fetchUrl = url + (url.includes('?') ? '&' : '?') + 'ajax=1';

                fetch(fetchUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                         window.location.href = response.url;
                         return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.status === 'ok') {
                        updateCartBadge(data.cart_count);
                        toast.show();
                    }
                })
                .catch(err => {
                    console.error('Error al agregar al carrito:', err);
                    // Respaldo a navegación normal si fetch falla
                    window.location.href = url;
                });
            }
        });

        // Maneja envío de formulario modal (AJAX)
        document.body.addEventListener('submit', function(e) {
            if (e.target.classList.contains('add-to-cart-form')) {
                e.preventDefault();
                const form = e.target;
                const url = form.action;
                const formData = new FormData(form);
                const size = formData.get('size');
                
                if (!size) return;

                const fetchUrl = `${url}?size=${encodeURIComponent(size)}&ajax=1`;

                fetch(fetchUrl, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === 'ok') {
                        const modalEl = form.closest('.modal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();

                        updateCartBadge(data.cart_count);
                        toast.show();
                    }
                })
                .catch(err => {
                    console.error('Error adding to cart:', err);
                    form.submit();
                });
            }
        });

        function updateCartBadge(count) {
            const cartLinks = document.querySelectorAll('a[aria-label="Carrito"]');
            cartLinks.forEach(link => {
                let badge = link.querySelector('.badge');
                if (!badge && count > 0) {
                    badge = document.createElement('span');
                    badge.className = 'badge bg-danger rounded-pill ms-1';
                    link.appendChild(badge);
                }
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 9 ? '9+' : count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
        }
    });
  </script>
  {% block scripts %}{% endblock %}
  {% block extra_js %}{% endblock %}
</body>
</html>
