<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor Visual de Email</title>
    
    <!-- GrapesJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <!-- GrapesJS Preset Newsletter CSS -->
    <link rel="stylesheet" href="https://unpkg.com/grapesjs-preset-newsletter/dist/grapesjs-preset-newsletter.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #gjs { border: 0; min-height: 100%; }
        
        /* Top Bar Styling */
        .panel-top { 
            height: 60px;
            padding: 0 20px; 
            background: #212529; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #444;
        }
        
        .btn-save { 
            background: #198754; 
            color: white; 
            border: none; 
            padding: 8px 20px; 
            cursor: pointer; 
            font-size: 14px; 
            border-radius: 4px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-save:hover { background: #157347; }
        
        .btn-back { 
            background: transparent; 
            color: #adb5bd; 
            text-decoration: none; 
            padding: 8px 15px; 
            border-radius: 4px;
            border: 1px solid #6c757d;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-back:hover { background: #343a40; color: white; }

        .template-name { font-weight: bold; font-size: 1.1rem; margin-left: 15px; }
        
        /* Custom Block Styling Override */
        .gjs-block {
            border: 1px solid #444;
            border-radius: 3px;
        }
        .gjs-block:hover {
            border-color: #198754;
            color: #198754;
        }

        .editor-layout {
            display: flex;
            height: calc(100% - 60px);
            background: #f8f9fb;
        }

        .sidebar {
            width: 320px;
            border-right: 1px solid #dee2e6;
            background: #fff;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #f1f3f5;
        }

        .sidebar-section h4 {
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6c757d;
            margin-bottom: 12px;
        }

        #blocks {
            max-height: 50vh;
            overflow-y: auto;
        }

        .placeholder-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .placeholder-pill {
            border: 1px dashed #6c757d;
            background: #f8f9fa;
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .placeholder-pill:hover {
            border-color: #198754;
            color: #198754;
            background: #e8f5ec;
        }

        .canvas-wrapper {
            flex: 1;
            overflow: hidden;
        }
    </style>
</head>
<body>

    <div class="panel-top">
        <div style="display: flex; align-items: center;">
            <a href="{% url 'marketing_dashboard' %}?tab=templates" class="btn-back">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <span class="template-name">{{ template.name }}</span>
        </div>
        <div>
            <button onclick="saveTemplate()" class="btn-save">
                <i class="bi bi-save"></i> Guardar Diseño
            </button>
        </div>
    </div>

    <div class="editor-layout">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h4>Bloques</h4>
                <div id="blocks"></div>
            </div>
            <div class="sidebar-section">
                <h4>Placeholders rápidos</h4>
                <p style="font-size: 0.8rem; color: #868e96;">Haz clic para copiar y luego pégalo en el bloque seleccionado.</p>
                <div class="placeholder-grid">
                    <button type="button" class="placeholder-pill" data-placeholder-token="{% templatetag openvariable %} nombre {% templatetag closevariable %}">{% templatetag openvariable %} nombre {% templatetag closevariable %}</button>
                    <button type="button" class="placeholder-pill" data-placeholder-token="{% templatetag openvariable %} codigo_cupon {% templatetag closevariable %}">{% templatetag openvariable %} codigo_cupon {% templatetag closevariable %}</button>
                    <button type="button" class="placeholder-pill" data-placeholder-token="{% templatetag openvariable %} fecha_expiracion {% templatetag closevariable %}">{% templatetag openvariable %} fecha_expiracion {% templatetag closevariable %}</button>
                </div>
            </div>
        </aside>
        <div class="canvas-wrapper">
            <div id="gjs"></div>
        </div>
    </div>

    <!-- GrapesJS JS -->
    <script src="https://unpkg.com/grapesjs"></script>
    <!-- GrapesJS Preset Newsletter Plugin -->
    <script src="https://unpkg.com/grapesjs-preset-newsletter"></script>

    <script type="text/javascript">
        const PLACEHOLDERS = {
            nombre: `{% templatetag openvariable %} nombre {% templatetag closevariable %}`,
            cupon: `{% templatetag openvariable %} codigo_cupon {% templatetag closevariable %}`,
            fecha: `{% templatetag openvariable %} fecha_expiracion {% templatetag closevariable %}`
        };

        const editor = grapesjs.init({
            container: '#gjs',
            plugins: ['grapesjs-preset-newsletter'],
            pluginsOpts: {
                'grapesjs-preset-newsletter': {
                    modalTitleImport: 'Importar Template',
                    // Desactivamos bloques por defecto si queremos limpiar, 
                    // pero el preset trae cosas útiles (columnas, texto, imagen).
                }
            },
            storageManager: false, // Gestionaremos el guardado manualmente
            blockManager: {
                appendTo: '#blocks',
            },
        });

        // --- CUSTOM BLOCKS FOR PLACEHOLDERS ---
        const blockManager = editor.BlockManager;

        // Categoría: Datos Dinámicos
        const category = 'Datos Dinámicos';

        // Bloque: Nombre del Cliente
        blockManager.add('var-nombre', {
            label: 'Nombre Cliente',
            category: category,
            attributes: { class: 'bi bi-person-badge' }, // Icono (requiere font awesome o similar, o texto)
            content: {
                type: 'text',
                content: PLACEHOLDERS.nombre,
                style: { padding: '10px', 'font-weight': 'bold', color: '#555' },
                activeOnRender: 1
            }
        });

        // Bloque: Código de Cupón
        blockManager.add('var-cupon', {
            label: 'Código Cupón',
            category: category,
            attributes: { class: 'bi bi-ticket-perforated' },
            content: {
                type: 'text',
                content: `<div style="border: 2px dashed #198754; padding: 15px; text-align: center; background-color: #f8f9fa; color: #198754; font-size: 20px; font-weight: bold;">${PLACEHOLDERS.cupon}</div>`,
            }
        });

        // Bloque: Fecha Expiración
        blockManager.add('var-fecha', {
            label: 'Fecha Expiración',
            category: category,
            attributes: { class: 'bi bi-calendar-event' },
            content: {
                type: 'text',
                content: PLACEHOLDERS.fecha,
            }
        });

        // Cargar diseño previo si existe
        let savedDesign = {};
        try {
            savedDesign = JSON.parse('{{ design_json|escapejs }}');
        } catch (error) {
            console.warn('No se pudo parsear el diseño guardado:', error);
        }
        if (savedDesign && Object.keys(savedDesign).length > 0) {
            editor.loadProjectData(savedDesign);
        }

        // Función para guardar
        function saveTemplate() {
            // gjs-get-inlined-html obtiene el HTML con estilos inline, ideal para emails
            const html = editor.runCommand('gjs-get-inlined-html'); 
            const components = editor.getProjectData(); 

            fetch("{% url 'save_marketing_template' template.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    html: html,
                    components: components
                })
            })
            .then(response => {
                if(response.ok) {
                    // Notificación visual simple
                    const btn = document.querySelector('.btn-save');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check-lg"></i> Guardado!';
                    btn.style.background = '#0d6efd';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#198754';
                    }, 2000);
                } else {
                    alert('Error al guardar');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Copiar placeholders rápidos
        document.querySelectorAll('[data-placeholder-token]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const token = btn.getAttribute('data-placeholder-token');
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(token);
                    } else {
                        const temp = document.createElement('textarea');
                        temp.value = token;
                        document.body.appendChild(temp);
                        temp.select();
                        document.execCommand('copy');
                        temp.remove();
                    }
                    const original = btn.textContent;
                    btn.textContent = 'Copiado';
                    btn.style.borderColor = '#198754';
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.style.borderColor = '';
                    }, 1500);
                } catch (err) {
                    alert('No se pudo copiar automáticamente. Copia manualmente: ' + token);
                }
            });
        });
    </script>
</body>
</html>