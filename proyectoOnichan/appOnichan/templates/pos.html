{% extends "base.html" %}
{% load static %}

{% block title %}Caja (POS){% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboardtrabajador.css' %}">
{% endblock %}

{% block content %}
  <main class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h4 mb-0">Caja - Venta presencial</h1>
      <a href="{% url 'dashboardtrabajador' %}" class="btn btn-pastel-secondary"><i class="bi bi-arrow-left me-2"></i>Volver</a>
    </header>

    {% if pos_errors %}
      <div class="alert alert-danger" role="alert">
        <strong>No hay stock suficiente</strong>
        <ul class="mb-0 mt-2">
          {% for e in pos_errors %}
            <li>{{ e.name }}: solicitado {{ e.requested }}, disponible {{ e.available }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="row g-4">
      <section class="col-12 col-lg-7">
        <article class="card-pastel">
          <header><h3 class="h5 mb-0">Productos</h3></header>
          <div class="p-3">
            <div class="row row-cols-2 row-cols-md-3 g-3">
              {% for p in productos %}
                <div class="col">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="ratio ratio-1x1"><img src="{{ p.image_url }}" alt="{{ p.name }}" class="img-fluid object-fit-cover rounded-top"></div>
                    <div class="card-body">
                      <div class="small text-muted">#{{ p.id }}</div>
                      <div class="fw-semibold">{{ p.name }}</div>
                      <div class="text-primary fw-bold">${{ p.price }}</div>
                    </div>
                    <div class="card-footer bg-white border-0">
                      {% if p.stock > 0 %}
                      <form method="post" class="d-flex gap-2 align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="product_id" value="{{ p.id }}">
                        <input type="number" name="qty" value="1" min="1" max="{{ p.stock }}" class="form-control form-control-sm" style="width:90px;">
                        <button class="btn btn-sm btn-pastel"><i class="bi bi-plus-lg me-1"></i>Agregar</button>
                      </form>
                      {% else %}
                      <div class="text-center text-danger fw-bold">Sin Stock</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </article>
      </section>

      <section class="col-12 col-lg-5">
        <article class="card-pastel">
          <header class="d-flex justify-content-between align-items-center">
            <h3 class="h5 mb-0">Carrito</h3>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="clear">
              <button class="btn btn-sm btn-pastel-danger"><i class="bi bi-trash me-1"></i>Vaciar</button>
            </form>
          </header>
          <div class="p-3">
            {% if cart_items %}
              <div class="mb-3">
                <label class="form-label">Fecha del pedido</label>
                <input type="date" class="form-control" name="order_date_display" value="{{ today|default:'' }}" oninput="document.getElementById('order_date').value=this.value">
              </div>
              <ul class="list-group list-group-flush">
                {% for it in cart_items %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ it.name }}</div>
                      <small class="text-muted">x{{ it.qty }} Â· ${{ it.price }} = ${{ it.subtotal }}</small>
                    </div>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="remove">
                      <input type="hidden" name="product_id" value="{{ it.id }}">
                      <button class="btn btn-sm btn-pastel-secondary"><i class="bi bi-x"></i></button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="fs-5">Total</div>
                <div class="fs-4 fw-bold text-primary">${{ cart_total }}</div>
              </div>
              <form method="post" class="mt-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="finalize">
                <input type="hidden" id="order_date" name="order_date" value="{{ today|default:'' }}">
                <button class="btn btn-pastel w-100"><i class="bi bi-check2-circle me-2"></i>Finalizar venta</button>
              </form>
            {% else %}
              <p class="text-muted">Agrega productos para iniciar una venta.</p>
            {% endif %}
          </div>
        </article>
      </section>
    </div>
  </main>
{% endblock %}
