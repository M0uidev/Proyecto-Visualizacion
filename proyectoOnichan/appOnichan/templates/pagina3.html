{% extends "base.html" %}
{% load static %}

{% block title %}Administración de Stock{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/pages/dashboardtrabajador.css' %}">
  <link rel="stylesheet" href="{% static 'css/pages/pagina3.css' %}">
{% endblock %}

{% block content %}
  <!-- Inventory modal -->
  <div class="modal" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-wide">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title modal-title-lg">Detalles de Categoría</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="chart-modal-body">
            <canvas id="modalChart" class="chart-modal-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="container-fluid py-4">
    <!-- Page header -->
    <div class="mb-4">
      <a href="{% url 'dashboardtrabajador' %}" class="btn btn-primary dashboard-link">
        <i class="bi bi-graph-up me-2"></i>Dashboard Administrador
      </a>
    </div>

    <div class="dashboard-wrapper">
      <!-- Toolbar -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">Administración de Stock</h2>
        <div class="d-flex gap-2">
          <button id="btnRefresh" class="btn btn-primary">
            <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
          </button>
          <button id="btnAdd" class="btn btn-success">
            <i class="bi bi-plus-lg me-2"></i>Nuevo Producto
          </button>
        </div>
      </div>

      <!-- Charts and table -->
      <div class="row g-4">
        <div class="col-12 col-lg-5">
          <article class="dash-card dash-card-stack">
            <header>
              <h3>Inventario por Categoría</h3>
            </header>
            <div class="chart-wrapper chart-wrapper-lg">
              <canvas id="stockByCategory"></canvas>
            </div>
          </article>
        </div>

        <div class="col-12 col-lg-7">
          <section class="dash-card dash-card-stack">
            <header class="d-flex justify-content-between align-items-center">
              <h3 class="h5 mb-0">Inventario</h3>
              <span class="text-muted" id="tableStats">0 productos</span>
            </header>

            <div class="p-4">
              <div class="d-flex flex-wrap gap-2 mb-4">
                <button class="chip active" data-filter="all">Todos</button>
                <button class="chip" data-filter="category:Ropa">Ropa</button>
                <button class="chip" data-filter="category:Calzado">Calzado</button>
                <button class="chip" data-filter="category:Accesorios">Accesorios</button>
                <button class="chip" data-filter="stock:bajo">Stock Bajo</button>
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle table-inventory" id="stockTable">
                  <thead>
                    <tr>
                      <th>Código</th>
                      <th>Producto</th>
                      <th>Categoría</th>
                      <th>Stock</th>
                      <th>Precio</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script src="{% static 'chart.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Utilidades
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const peso = (x) => x.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });

      // Variables globales para el modal
      let modalChartInstance = null;

      // Datos reales de la base de datos
      const orders = JSON.parse('{{ data|safe }}').orders;
      const stats = JSON.parse('{{ data|safe }}').estadisticas;

      // Agregamos el estado de stock para cada producto
      const PRODUCTS = [];
      const seenProducts = new Set();

      orders.forEach((order) => {
        order.productos.forEach((prod) => {
          const key = prod.nombre;
          if (!seenProducts.has(key)) {
            seenProducts.add(key);

            const price = order.total / order.productos.reduce((acc, p) => acc + p.cantidad, 0);

            PRODUCTS.push({
              code: key.toLowerCase().replace(/\s+/g, '-'),
              name: prod.nombre,
              price: Math.round(price),
              category: prod.nombre.includes('Polera') || prod.nombre.includes('Pantalón') || prod.nombre.includes('Chaqueta') || prod.nombre.includes('Polerón') ? 'Ropa'
                : prod.nombre.includes('Zapatillas') || prod.nombre.includes('Botines') ? 'Calzado'
                : 'Accesorios',
              stock: Math.floor(Math.random() * 100),
              status: 'Disponible'
            });
          }
        });
      });

      const CATEGORIES = [...new Set(PRODUCTS.map((p) => p.category))];

      // Estado
      let currentCategory = 'all';
      let currentSort = { field: 'name', direction: 'asc' };
      let searchQuery = '';

      // Funciones de utilidad
      function getStatusClass(status) {
        return {
          'Disponible': 'success',
          'Stock Bajo': 'warning',
          'Sin Stock': 'danger'
        }[status] || 'secondary';
      }

      function updateStockStatus(product) {
        if (product.stock <= 0) return 'Sin Stock';
        if (product.stock <= 10) return 'Stock Bajo';
        return 'Disponible';
      }

      // Filtrado de productos
      function filterProducts(products) {
        return products.filter((product) => {
          if (currentCategory !== 'all') {
            if (currentCategory === 'stock:bajo') {
              if (product.stock > 10) return false;
            } else if (currentCategory.startsWith('category:')) {
              if (product.category !== currentCategory.split(':')[1]) return false;
            }
          }

          if (searchQuery) {
            const query = searchQuery.toLowerCase();
            return product.name.toLowerCase().includes(query)
              || product.code.toLowerCase().includes(query)
              || product.category.toLowerCase().includes(query);
          }

          return true;
        });
      }

      // Renderizado de la tabla
      function renderTable() {
        const filtered = filterProducts(PRODUCTS);
        const sorted = [...filtered].sort((a, b) => {
          const factor = currentSort.direction === 'asc' ? 1 : -1;
          return a[currentSort.field] > b[currentSort.field] ? factor : -factor;
        });

        const tbody = $('#stockTable tbody');
        tbody.innerHTML = sorted.map((product) => `
          <tr>
            <td>${product.code}</td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td>${product.stock}</td>
            <td>${peso(product.price)}</td>
            <td><span class="badge bg-${getStatusClass(product.status)}">${product.status}</span></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${product.code}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${product.code}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        $('#tableStats').textContent = `${filtered.length} productos`;
        updateChart();
      }

      // Actualización del gráfico
      function updateChart() {
        const ctx = $('#stockByCategory').getContext('2d');
        const productsByCategory = CATEGORIES.map((category) => ({
          category,
          count: PRODUCTS.filter((p) => p.category === category).length,
          totalStock: PRODUCTS.filter((p) => p.category === category)
            .reduce((sum, p) => sum + p.stock, 0)
        }));

        if (window.stockChart) {
          window.stockChart.destroy();
        }

        const colorPalette = ['#4f46e5', '#22c55e', '#f97316', '#0ea5e9', '#ec4899', '#f59e0b', '#8b5cf6'];

        window.stockChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: productsByCategory.map((p) => p.category),
            datasets: [{
              data: productsByCategory.map((p) => p.totalStock),
              backgroundColor: productsByCategory.map((_, i) => colorPalette[i % colorPalette.length]),
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: {
                top: 20,
                bottom: 20
              }
            },
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  font: { size: 14 },
                  padding: 20,
                  usePointStyle: true,
                  boxWidth: 10,
                  boxHeight: 10
                }
              },
              tooltip: {
                titleFont: { size: 16 },
                bodyFont: { size: 14 },
                padding: 12,
                callbacks: {
                  label: (context) => {
                    const totalItems = context.dataset.data[context.dataIndex];
                    const totalProducts = PRODUCTS.filter((p) => p.category === context.label).length;
                    return [
                      `Stock Total: ${totalItems} unidades`,
                      `${totalProducts} productos diferentes`
                    ];
                  }
                }
              }
            },
            onClick: (evt, elements) => {
              if (!elements.length) return;
              const index = elements[0].index;
              const category = productsByCategory[index].category;
              const productsInCategory = PRODUCTS.filter((p) => p.category === category)
                .sort((a, b) => b.stock - a.stock);

              const sales = {};
              orders.forEach((order) => {
                order.productos.forEach((prod) => {
                  if (productsInCategory.find((p) => p.name === prod.nombre)) {
                    sales[prod.nombre] = (sales[prod.nombre] || 0) + prod.cantidad;
                  }
                });
              });

              if (modalChartInstance) {
                modalChartInstance.destroy();
              }

              const modalCanvas = document.getElementById('modalChart');
              const modal = document.getElementById('chartModal');
              const modalTitle = modal.querySelector('.modal-title');
              modalTitle.textContent = `Detalle de ${category}`;

              modalChartInstance = new Chart(modalCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                  labels: productsInCategory.map((p) => p.name),
                  datasets: [
                    {
                      label: 'Stock',
                      data: productsInCategory.map((p) => p.stock),
                      backgroundColor: colorPalette[index % colorPalette.length] + '80',
                      borderWidth: 1,
                      order: 2
                    },
                    {
                      label: 'Ventas',
                      data: productsInCategory.map((p) => sales[p.name] || 0),
                      backgroundColor: colorPalette[(index + 1) % colorPalette.length] + '80',
                      borderWidth: 1,
                      order: 1
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  indexAxis: 'y',
                  plugins: {
                    title: {
                      display: true,
                      text: 'Stock y Ventas por Producto',
                      font: {
                        size: 20,
                        weight: 'bold'
                      },
                      padding: 20
                    },
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        font: { size: 16 },
                        usePointStyle: true,
                        padding: 20
                      }
                    },
                    tooltip: {
                      titleFont: { size: 16 },
                      bodyFont: { size: 15 },
                      padding: 12,
                      callbacks: {
                        label: (context) => {
                          const product = productsInCategory[context.dataIndex];
                          if (context.dataset.label === 'Stock') {
                            return `Stock: ${product.stock} unidades · Precio: ${peso(product.price)}`;
                          }
                          return `Ventas: ${sales[product.name] || 0} unidades`;
                        }
                      }
                    }
                  },
                  scales: {
                    x: {
                      stacked: false,
                      grid: {
                        display: false
                      },
                      ticks: {
                        font: { size: 14 },
                        callback(value) {
                          return value + ' unidades';
                        }
                      },
                      title: {
                        display: true,
                        text: 'Cantidad',
                        font: {
                          size: 16,
                          weight: 'bold'
                        },
                        padding: { top: 20, bottom: 10 }
                      }
                    },
                    y: {
                      stacked: false,
                      grid: {
                        display: true,
                        drawBorder: false
                      },
                      ticks: {
                        font: { size: 15 },
                        padding: 10
                      },
                      title: {
                        display: true,
                        text: 'Productos',
                        font: {
                          size: 16,
                          weight: 'bold'
                        },
                        padding: { top: 20, bottom: 10 }
                      }
                    }
                  }
                }
              });

              const bsModal = new bootstrap.Modal(modal);
              modal.addEventListener('shown.bs.modal', function () {
                modalCanvas.style.height = '400px';
                modalChartInstance.resize();
              });
              bsModal.show();
            }
          }
        });

        document.getElementById('chartModal').addEventListener('hidden.bs.modal', () => {
          if (modalChartInstance) {
            modalChartInstance.destroy();
            modalChartInstance = null;
          }
        });

        document.getElementById('stockByCategory').addEventListener('click', () => {
          console.log('Click en el gráfico detectado');
        });
      }

      // Manejadores de eventos
      $$('.chip').forEach((button) => {
        button.addEventListener('click', (e) => {
          $$('.chip').forEach((b) => b.classList.remove('active'));
          e.target.classList.add('active');

          currentCategory = e.target.dataset.filter;
          renderTable();
        });
      });

      $('#btnRefresh').addEventListener('click', () => location.reload());
      $('#btnAdd').addEventListener('click', () => {
        alert('Funcionalidad de agregar producto pendiente');
      });

      $('#stockTable').addEventListener('click', (e) => {
        const button = e.target.closest('[data-action]');
        if (!button) return;

        const action = button.dataset.action;
        const productId = button.dataset.id;

        if (action === 'edit') {
          alert(`Editar producto ${productId}`);
        } else if (action === 'delete') {
          alert(`Eliminar producto ${productId}`);
        }
      });

      renderTable();
    });
  </script>
{% endblock %}
