{% extends "basecliente.html" %}
{% load static %}

{% block title %}Productos · Multitienda{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboardtrabajador.css' %}">
  <link rel="stylesheet" href="{% static 'css/pages/pagina1.css' %}">
{% endblock %}

{% block content %}
  <!-- Hero Section -->
  <section class="container-fluid px-0 mb-5">
    <div class="rounded-3 p-5 text-center" style="background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);">
      <h1 class="display-4 fw-bold mb-3" style="color: var(--text-main);">Nuevas Colecciones</h1>
      <p class="lead text-muted mb-4">Descubre lo último en tendencias con un estilo único.</p>
      <a href="#ofertas" class="btn btn-pastel btn-lg px-5" style="background: white; color: var(--color-primary-dark);">Ver Ofertas</a>
    </div>
  </section>

  <!-- 1) Sección Ofertas Imperdibles (Carrusel) -->
  <section class="container mb-5 position-relative" id="ofertas">
    <h2 class="h3 fw-bold mb-4">Ofertas Imperdibles</h2>
    
    <div class="position-relative px-4"> <!-- Added padding for arrows -->
      <button class="btn btn-light rounded-circle shadow position-absolute top-50 start-0 translate-middle-y z-2 d-none d-md-flex align-items-center justify-content-center" id="prevOffer" style="width: 40px; height: 40px; left: 0;">
        <i class="bi bi-chevron-left"></i>
      </button>
      
      <div class="scrolling-wrapper-flexbox py-2 d-flex flex-nowrap" id="offersCarousel">
        {% for producto in productos|slice:":12" %} <!-- Increased slice to show more items -->
          <div class="card-product-carousel">
            <article class="card-product h-100">
              <div class="position-relative">
                <div class="ratio ratio-1x1 product-thumb">
                  <img src="{{ producto.image_url }}" alt="{{ producto.name }}" class="img-fluid rounded-top">
                </div>
                {% if producto.productdetail.discount_percentage %}
                  <span class="position-absolute top-0 start-0 m-2 badge bg-danger rounded-pill">-{{ producto.productdetail.discount_percentage }}%</span>
                {% endif %}
              </div>
              <div class="card-body p-3 d-flex flex-column">
                <h3 class="h6 product-title mb-2" title="{{ producto.name }}">{{ producto.name }}</h3>
                <div class="mt-auto w-100">
                  {% if producto.productdetail.discount_percentage %}
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="text-decoration-line-through text-muted small">${{ producto.price }}</span>
                      <span class="fw-bold text-danger fs-5">${{ producto.productdetail.discounted_price|default:producto.price }}</span>
                    </div>
                  {% else %}
                    <div class="fw-bold text-primary fs-5 mb-2">${{ producto.price }}</div>
                  {% endif %}
                  <a href="{% url 'producto_detalle' producto.id %}" class="btn btn-pastel-secondary btn-sm w-100">Ver detalles</a>
                </div>
              </div>
            </article>
          </div>
        {% endfor %}
      </div>

      <button class="btn btn-light rounded-circle shadow position-absolute top-50 end-0 translate-middle-y z-2 d-none d-md-flex align-items-center justify-content-center" id="nextOffer" style="width: 40px; height: 40px; right: 0;">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </section>

  <!-- 2) Sección Descubre nuevas categorías -->
  <section class="container mb-5">
    <h2 class="h3 fw-bold mb-4">Descubre nuevas categorías</h2>
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-3">
      {% for cat in categories %}
        <div class="col">
          <a href="?category={{ cat.slug }}" class="text-decoration-none">
            <div class="card h-100 border-0 shadow-sm category-card text-center p-3">
              <div class="category-icon mb-2 mx-auto rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background-color: var(--color-secondary);">
                <i class="bi bi-tag-fill text-success"></i>
              </div>
              <h6 class="mb-0 text-dark small fw-bold">{{ cat.name }}</h6>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </section>

  <!-- 3) Sección Productos filtrables por chips -->
  <section class="container mb-5" id="imperdibles">
    <div class="d-flex flex-column align-items-center mb-4">
      <h2 class="h3 fw-bold mb-3">Imperdibles</h2>
      <div class="d-flex flex-wrap justify-content-center gap-2" id="filterChips">
        <button class="btn btn-sm btn-outline-primary rounded-pill active filter-chip" data-filter="all">Todos</button>
        {% for cat in categories %}
          <button class="btn btn-sm btn-outline-primary rounded-pill filter-chip" data-filter="{{ cat.slug }}">{{ cat.name }}</button>
        {% endfor %}
      </div>
    </div>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="filterableProducts">
      {% for producto in productos %}
        <div class="col product-item" data-category="{{ producto.category.slug }}">
          <article class="card-product h-100">
            <div class="position-relative">
              <div class="ratio ratio-1x1 product-thumb">
                <img src="{{ producto.image_url }}" alt="{{ producto.name }}" class="img-fluid object-fit-cover rounded-top">
              </div>
            </div>
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <h3 class="h6 product-title mb-0 text-truncate" style="max-width: 70%;">{{ producto.name }}</h3>
                <div class="product-price fw-bold text-primary">${{ producto.price }}</div>
              </div>
              <p class="small text-muted mb-2">{{ producto.category.name|default:"General" }}</p>
              
              <div class="d-grid gap-2 mt-3">
                <a href="{% url 'producto_detalle' producto.id %}" class="btn btn-pastel-secondary btn-sm">Ver detalles</a>
                <a href="{% url 'add_to_cart' producto.id %}" class="btn btn-pastel btn-sm add-to-cart-btn" data-product-id="{{ producto.id }}">Agregar al carrito</a>
              </div>
            </div>
          </article>
        </div>
      {% endfor %}
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Carousel Logic
      const scrollContainer = document.getElementById('offersCarousel');
      const prevBtn = document.getElementById('prevOffer');
      const nextBtn = document.getElementById('nextOffer');

      if(scrollContainer && prevBtn && nextBtn) {
        nextBtn.addEventListener('click', () => {
          const card = scrollContainer.querySelector('.card-product-carousel');
          if (card) {
            const gap = 16;
            const scrollAmount = card.offsetWidth + gap;
            
            // Check if we are near the end
            if (scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 10) {
              // Loop back to start
              scrollContainer.scrollTo({ left: 0, behavior: 'smooth' });
            } else {
              scrollContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
          }
        });
        
        prevBtn.addEventListener('click', () => {
          const card = scrollContainer.querySelector('.card-product-carousel');
          if (card) {
            const gap = 16;
            const scrollAmount = card.offsetWidth + gap;
            
            // Check if we are at the start
            if (scrollContainer.scrollLeft <= 10) {
              // Loop to end
              scrollContainer.scrollTo({ left: scrollContainer.scrollWidth, behavior: 'smooth' });
            } else {
              scrollContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            }
          }
        });
      }

      // Filter Logic
      const chips = document.querySelectorAll('.filter-chip');
      const products = document.querySelectorAll('.product-item');

      chips.forEach(chip => {
        chip.addEventListener('click', () => {
          // Remove active class from all
          chips.forEach(c => c.classList.remove('active', 'btn-primary'));
          chips.forEach(c => c.classList.add('btn-outline-primary'));
          
          // Add active to clicked
          chip.classList.add('active', 'btn-primary');
          chip.classList.remove('btn-outline-primary');

          const filter = chip.getAttribute('data-filter');

          products.forEach(prod => {
            if (filter === 'all' || prod.getAttribute('data-category') === filter) {
              prod.style.display = 'block';
            } else {
              prod.style.display = 'none';
            }
          });
        });
      });
    });
  </script>
{% endblock %}
