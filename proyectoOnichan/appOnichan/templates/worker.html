{% extends "base.html" %}

{% block title %}Panel de Trabajador{% endblock %}

{% block content %}
<div class="container" id="workerDashboard" data-worker-id="{{ worker_id }}">
  <section class="mb-4">
    <div class="row g-4 align-items-stretch">
      <div class="col-12 col-xl-5">
        <div class="card-surface p-4 h-100 d-flex flex-column justify-content-between">
          <div>
            <p class="text-uppercase small muted mb-1">Turno activo</p>
            <h1 class="h3 fw-semibold mb-1">{{ profile.name }}</h1>
            <p class="mb-2 muted">{{ profile.role }} · {{ profile.city }}</p>
          </div>
          <div class="d-flex flex-column gap-2">
            <span class="badge rounded-pill text-bg-primary align-self-start">ID {{ worker_id }}</span>
            <span class="muted">Actualizado: {{ profile.timestamp }}</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-7">
        <div class="card-surface h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Stats estilo JoJo's</span>
            <small class="muted">Haz clic para profundizar</small>
          </div>
          <div class="card-body">
            <div id="worker_stats_radar" data-chart='{{ stats_chart|escapejs }}' style="height: 360px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-4">
    <div class="row g-4">
      {% for stat in stats %}
      <div class="col-12 col-sm-6 col-xl-4">
        <div class="card-surface p-4 h-100">
          <p class="text-uppercase muted small mb-2">{{ stat.label }}</p>
          <div class="progress rounded-pill" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ stat.value }}%; background: linear-gradient(90deg, #f59e0b, #8b5cf6);" aria-valuenow="{{ stat.value }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <p class="fw-semibold fs-4 mb-0 mt-3">{{ stat.value }}%</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <section class="mb-4">
    <div class="row g-4">
      <div class="col-12 col-xl-7">
        <div class="card-surface h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Horario semanal</span>
            <small class="muted">Estado de cada turno</small>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Día</th>
                  <th>Turno</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                {% for item in schedule %}
                <tr>
                  <td class="fw-semibold">{{ item.day }}</td>
                  <td>{{ item.shift }}</td>
                  <td>
                    {% if item.status == 'Completado' %}
                    <span class="badge text-bg-success-subtle text-success">{{ item.status }}</span>
                    {% elif item.status == 'Próximo' %}
                    <span class="badge text-bg-warning-subtle text-warning">{{ item.status }}</span>
                    {% else %}
                    <span class="badge text-bg-secondary-subtle text-secondary">{{ item.status }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-5">
        <div class="card-surface h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Asistencia (14 días)</span>
            <small class="muted">Click para ver turno</small>
          </div>
          <div class="card-body">
            <div id="worker_attendance_chart" data-chart='{{ attendance|escapejs }}' style="height: 260px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-5">
    <div class="card-surface">
      <div class="card-header">
        <span>Notas y recordatorios</span>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0 d-grid gap-3">
          {% for note in notes %}
          <li class="d-flex gap-3 align-items-start">
            <span class="badge rounded-pill text-bg-info">•</span>
            <span>{{ note }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>

  <footer class="muted small d-flex flex-column flex-md-row justify-content-between gap-2">
    <span>Panel del colaborador · {{ profile.city }}</span>
    <span>Última sincronización: {{ profile.timestamp }}</span>
  </footer>
</div>
{% endblock %}

{% block extra_js %}
<!-- Modal genérico -->
<div class="modal fade" id="drillModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="drillTitle">Detalle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="drillChart" style="height:360px;"></div>
        <div class="table-responsive mt-3">
          <table class="table table-sm" id="drillTable"></table>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function openDrill(title){
  document.getElementById('drillTitle').textContent = title || 'Detalle';
  const m = new bootstrap.Modal(document.getElementById('drillModal'));
  m.show();
}

async function fetchJSON(url){
  const r = await fetch(url, {headers:{'Accept':'application/json'}});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function renderTable(elId, rows){
  const t = document.getElementById(elId);
  if(!rows || !rows.length){ t.innerHTML = '<tbody><tr><td class="text-muted">Sin datos</td></tr></tbody>'; return; }
  const thead = '<thead class="text-muted"><tr>'+Object.keys(rows[0]).map(k=>`<th>${k}</th>`).join('')+'</tr></thead>';
  const tbody = '<tbody>'+rows.map(r=>'<tr>'+Object.values(r).map(v=>`<td>${v}</td>`).join('')+'</tr>').join('')+'</tbody>';
  t.innerHTML = thead+tbody;
}

const elSales = document.getElementById('chart_sales_by_day');
if(elSales){
  elSales.on('plotly_click', async (e) => {
    try{
      const x = e.points?.[0]?.x;
      const storeSelect = document.getElementById('storeSelect');
      const storeValue = storeSelect?.value || 'A';
      const storeLabel = storeSelect?.selectedOptions?.[0]?.textContent?.trim() || 'Tienda A';
      openDrill('Órdenes del '+x+' · '+storeLabel);
      const data = await fetchJSON(`/api/drill/orders?date=${encodeURIComponent(x)}&store=${storeValue}`);
      Plotly.react('drillChart', data.traces || [], data.layout || {}, {displayModeBar:false, responsive:true});
      renderTable('drillTable', data.rows || []);
    }catch(err){ console.error(err); }
  });
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const currency = new Intl.NumberFormat('es-CL', {style: 'currency', currency: 'CLP', maximumFractionDigits: 0});
  const workerWrapper = document.getElementById('workerDashboard');
  const workerId = workerWrapper?.dataset.workerId || '';
  const chartConfig = {displayModeBar: false, responsive: true, locale: 'es'};

  const radarContainer = document.getElementById('worker_stats_radar');
  if (radarContainer) {
    const radarData = JSON.parse(radarContainer.dataset.chart);
    const radarTrace = {
      type: 'scatterpolar',
      r: radarData.values,
      theta: radarData.labels,
      fill: 'toself',
      line: {color: '#a855f7', width: 2},
      marker: {color: '#f59e0b'},
      customdata: radarData.values.map(value => `${value}%`),
      hovertemplate: '<b>%{theta}</b><br>Índice: %{customdata}<extra></extra>'
    };
    const radarLayout = {
      margin: {t: 24, r: 16, b: 24, l: 16},
      hovermode: 'closest',
      polar: {
        bgcolor: 'transparent',
        radialaxis: {
          visible: true,
          range: [0, 100],
          tickmode: 'array',
          tickvals: [0, 25, 50, 75, 100],
          tickfont: {color: '#94a3b8'}
        },
        angularaxis: {
          tickfont: {color: '#94a3b8'}
        }
      },
      showlegend: false
    };
    Plotly.newPlot(radarContainer, [radarTrace], radarLayout, chartConfig);

    radarContainer.on('plotly_click', async (e) => {
      try {
        const metric = e.points?.[0]?.theta;
        if (!metric) return;
        openDrill(`Tendencia de ${metric}`);
        const data = await fetchJSON(`/api/drill/metric?name=${encodeURIComponent(metric)}&worker_id=${encodeURIComponent(workerId)}`);
        Plotly.react('drillChart', data.traces || [], data.layout || {}, {displayModeBar:false, responsive:true});
        renderTable('drillTable', data.rows || []);
      } catch (err) {
        console.error(err);
      }
    });
  }

  const attendanceContainer = document.getElementById('worker_attendance_chart');
  if (attendanceContainer) {
    const attendanceData = JSON.parse(attendanceContainer.dataset.chart);
    const attendanceTrace = {
      x: attendanceData.labels,
      y: attendanceData.values,
      type: 'bar',
      marker: {color: '#38bdf8'},
      customdata: attendanceData.values.map(value => `${Math.round(value * 100)}%`),
      hovertemplate: '%{x}<br>Asistencia: %{customdata}<extra></extra>'
    };
    const attendanceLayout = {
      margin: {t: 24, r: 16, b: 48, l: 60},
      hovermode: 'closest',
      yaxis: {
        title: 'Asistencia',
        range: [0, 1.1],
        tickformat: ',.0%',
        gridcolor: 'rgba(148, 163, 184, 0.2)'
      },
      xaxis: {
        tickangle: -25
      }
    };
    Plotly.newPlot(attendanceContainer, [attendanceTrace], attendanceLayout, chartConfig);

    attendanceContainer.on('plotly_click', async (e) => {
      try {
        const pointIndex = e.points?.[0]?.pointNumber ?? 0;
        const date = attendanceData.dates?.[pointIndex] || attendanceData.labels?.[pointIndex];
        if (!date) return;
        openDrill(`Detalle de turno · ${date}`);
        const data = await fetchJSON(`/api/drill/shift?date=${encodeURIComponent(date)}&worker_id=${encodeURIComponent(workerId)}`);
        Plotly.react('drillChart', data.traces || [], data.layout || {}, {displayModeBar:false, responsive:true});
        renderTable('drillTable', data.rows || []);
      } catch (err) {
        console.error(err);
      }
    });
  }
});
</script>
{% endblock %}
